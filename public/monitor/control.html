<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配置 - 网站监控系统</title>
    <link rel="stylesheet" href="fontawesome.css">
    <link rel="stylesheet" href="index.css">
    <style>
        body {
            background-color: var(--bg-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.5rem 2rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            box-shadow: var(--card-shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 {
            color: white;
            margin: 0;
            font-size: 24px;
            flex-shrink: 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .user-info span {
            color: white;
            font-weight: 500;
        }

        .change-password-btn, .logout-btn {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 10px 18px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            backdrop-filter: blur(10px);
        }

        .change-password-btn:hover, .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-1px);
        }

        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-1px);
        }

        .systems-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .system-card {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.08);
            padding: 22px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #f0f0f0;
        }

        .system-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
            border-color: var(--primary-color);
        }

        /* Authorization management styles */
.system-card[data-system-name] {
    border-left: 4px solid var(--primary-color);
}

/* Example styles for authorized/unauthorized states */
.system-card.authorized {
    border-left-color: #27ae60; /* Green for authorized */
}

.system-card.unauthorized {
    border-left-color: #e74c3c; /* Red for unauthorized */
    opacity: 0.7;
    cursor: not-allowed;
}

.system-card h2 {
            margin: 0 0 10px 0;
            color: var(--primary-color);
            font-size: 20px;
        }

        .system-url {
            color: #666;
            margin-bottom: 15px;
            font-size: 14px;
            word-break: break-all;
        }

        .api-key {
            background-color: #2d2d2d;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            overflow-x: auto;
            overflow-y: auto;
            height: 260px;
            position: relative;
        }

        .copy-btn {
            cursor: pointer;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background-color: #333;
            color: #fff;
            border: none;
            padding: 3px 8px;
            border-radius: 3px;
            line-height: 18px;
        }

        .copy-btn:hover {
            background-color: #444;
        }

        .copy-btn.copied {
            background-color: #27ae60;
        }
        
        /* 授权管理样式 */
        .authorization-section {
            margin-top: 20px;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            border: 1px solid #e1e8ed;
        }
        
        .authorization-section h3 {
            margin: 0 0 15px 0;
            color: var(--primary-color);
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .authorized-users-list {
            max-height: 200px;
            overflow-y: auto;
            background-color: #f5f8fa;
            border-radius: 4px;
            padding: 10px;
            border: 1px solid #e1e8ed;
        }
        
        .authorized-user-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            margin-bottom: 6px;
            background-color: white;
            border-radius: 4px;
            border: 1px solid #e1e8ed;
            font-size: 14px;
        }
        
        .authorized-user-item:last-child {
            margin-bottom: 0;
        }
        
        .authorized-user-item.creator {
            background-color: rgba(39, 174, 96, 0.1);
            border-color: rgba(39, 174, 96, 0.3);
        }
        
        .authorized-user-item .username {
            font-weight: 600;
            margin-right: 8px;
            color: var(--primary-color);
        }
        
        .authorized-user-item .full-name {
            color: #657786;
            margin-right: 8px;
        }
        
        .authorized-user-item .email {
            color: #8899a6;
            margin-right: auto;
            font-size: 13px;
        }
        
        .authorized-user-item .creator-badge {
            background-color: #27ae60;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .authorized-user-item .remove-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .authorized-user-item .remove-btn:hover {
            background-color: #c0392b;
        }
        
        .delete-btn {
            cursor: pointer;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background-color: #e74c3c;
            color: #fff;
            border: none;
            padding: 3px 8px;
            border-radius: 3px;
            line-height: 18px;
        }
        
        .delete-btn:hover {
            background-color: #c0392b;
        }

        .api-key-label {
            display: block;
            color: #888;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .api-key pre {
            margin: 0;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .api-key code {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            color: #f8f8f2;
            line-height: 1.5;
        }

        .create-system-section {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.08);
            padding: 25px;
            border: 1px solid #f0f0f0;
        }

        .create-system-section h2 {
            margin: 0 0 22px 0;
            color: var(--primary-color);
            font-size: 19px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .create-system-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 18px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            color: #555;
            font-size: 14px;
            font-weight: 500;
        }

        .form-group input {
            padding: 12px 14px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: all 0.3s ease;
            background-color: #fafafa;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
            background-color: white;
        }

        .create-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            height: 45px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .create-btn:hover {
            background-color: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state i {
            font-size: 50px;
            margin-bottom: 20px;
            color: #ddd;
        }

        .empty-state h3 {
            margin: 0 0 10px 0;
            color: #555;
        }

        .empty-state p {
            margin: 0 0 20px 0;
        }

        .error-message {
            color: #e74c3c;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
            background-color: rgba(231, 76, 60, 0.1);
        }

        .success-message {
            color: #27ae60;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
            background-color: rgba(39, 174, 96, 0.1);
        }

        /* 模态窗口样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .modal-header h2 {
            margin: 0;
            color: var(--primary-color);
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            color: #333;
            background-color: #f5f5f5;
        }

        .password-form {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .password-form .form-group {
            margin-bottom: 0;
        }

        .password-form .form-group input {
            padding: 12px 14px;
        }

        .password-form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 10px;
        }

        .cancel-btn {
            padding: 10px 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
            color: #555;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .cancel-btn:hover {
            background-color: #f5f5f5;
            border-color: #ccc;
        }

        .save-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .save-btn:hover {
            background-color: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .create-system-form {
                grid-template-columns: 1fr;
            }

            .systems-container {
                grid-template-columns: 1fr;
            }

            header {
                flex-direction: column;
                align-items: flex-start;
            }

            .user-info {
                margin-top: 15px;
            }
            
            .modal-content {
                margin: 25% auto;
                width: 95%;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-chart-line"></i> 监控配置 </h1>
            <div class="user-info">
                <span id="username"></span>
                <button class="change-password-btn" onclick="openChangePasswordModal()"><i class="fas fa-key"></i> 修改密码</button>
                <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </header>

        <div id="message" style="display: none;"></div>

        <div class="systems-container" id="systems-container">
            <!-- 系统卡片将通过JavaScript动态生成 -->
        </div>

        <div class="create-system-section">
            <h2><i class="fas fa-plus-circle"></i> 创建新的系统监控</h2>
            <div id="create-message" style="display: none;"></div>
            <form id="create-system-form" class="create-system-form">
                <div class="form-group">
                    <label for="new-system-name">系统名称</label>
                    <input type="text" id="new-system-name" name="system_name" placeholder="请输入系统名称" required>
                </div>
                <div class="form-group">
                    <label for="new-site-url">系统URL</label>
                    <input type="url" id="new-site-url" name="site_url" placeholder="请输入网站URL" required>
                </div>
                <button type="submit" class="create-btn"><i class="fas fa-plus"></i> 创建</button>
            </form>
        </div>

        <!-- 监控脚本使用说明 -->
        <div class="create-system-section" style="margin-top: 30px;">
            <h2><i class="fas fa-book"></i> 监控脚本使用说明</h2>
            <div style="padding: 20px; background-color: #f8f9fa; border-radius: 8px; margin-top: 20px;">
                <h3 style="margin-top: 0; color: #333;">基本用法</h3>
                <pre style="background-color: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px; overflow-x: auto; margin: 15px 0;"><code>&lt;script src="&lt;monitor-server-address&gt;/public/pagemonitor.min.js" data-system="系统名称" data-api-key="API密钥"&gt;&lt;/script&gt;</code></pre>
                
                <h3 style="color: #333; margin-top: 25px;">autoInitialize 功能</h3>
                <p>脚本默认会自动初始化监控功能，无需额外配置。如果需要禁用自动初始化，可以使用以下属性：</p>
                <pre style="background-color: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px; overflow-x: auto; margin: 15px 0;"><code>&lt;script src="&lt;monitor-server-address&gt;/public/pagemonitor.min.js" data-auto-init="false"&gt;&lt;/script&gt;</code></pre>
                
                <h3 style="color: #333; margin-top: 25px;">支持的 data-xxx 属性</h3>
                <ul style="margin: 15px 0; padding-left: 25px;">
                    <li><strong>data-system</strong>: 系统名称（必填）</li>
                    <li><strong>data-api-key</strong>: API密钥（必填）</li>
                    <li><strong>data-api-base-url</strong>: API基础URL（默认：/api）</li>
                    <li><strong>data-is-spa</strong>: 是否为SPA应用（true/false，默认：false）</li>
                    <li><strong>data-is-track-downloads</strong>: 是否跟踪下载（true/false，默认：true）</li>
                    <li><strong>data-max-pending-items</strong>: 最大待处理记录数（默认：50）</li>
                    <li><strong>data-log-level</strong>: 日志级别（debug/info/warn/error，默认：warn）</li>
                    <li><strong>data-custom-events</strong>: 自定义事件配置（JSON格式）</li>
                    <li><strong>data-active-time-threshold</strong>: 活跃时间阈值（秒，默认：600秒） - 用于计算停留时间</li>
                </ul>
                
                <h3 style="color: #333; margin-top: 25px;">自定义事件配置</h3>
                <p>可以通过 data-custom-events 属性配置自定义事件监控：</p>
                <pre style="background-color: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px; overflow-x: auto; margin: 15px 0;"><code>&lt;script src="&lt;monitor-server-address&gt;/public/pagemonitor.min.js" 
    data-system="系统名称" 
    data-api-key="API密钥" 
    data-custom-events='[
        {
            "selector": ".btn", 
            "eventType": "click", 
            "properties": {
                "category": "button",
                "action": "click",
                "label": "按钮点击"
            }
        },
        {
            "selector": "#login-form", 
            "eventType": "submit", 
            "properties": {
                "category": "form",
                "action": "submit",
                "label": "登录表单提交"
            }
        }
    ]'&gt;&lt;/script&gt;</code></pre>
                
                <p style="margin-top: 15px; color: #666;"><strong>配置说明：</strong></p>
                <ul style="margin: 15px 0; padding-left: 25px; color: #666;">
                    <li><strong>selector</strong>: CSS选择器，用于匹配要监控的元素</li>
                    <li><strong>eventType</strong>: 事件类型（默认：click）</li>
                    <li><strong>properties</strong>: 自定义事件属性，包含：
                        <ul style="margin-top: 5px; padding-left: 20px;">
                            <li>category: 事件类别</li>
                            <li>action: 事件动作</li>
                            <li>label: 事件标签</li>
                        </ul>
                    </li>
                </ul>
                
                <h3 style="color: #333; margin-top: 25px;">手动初始化（当禁用autoInitialize时）</h3>
                <pre style="background-color: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px; overflow-x: auto; margin: 15px 0;"><code>&lt;script src="&lt;monitor-server-address&gt;/public/pagemonitor.min.js" data-auto-init="false"&gt;&lt;/script&gt;
&lt;script&gt;
    // 等待DOM加载完成
    document.addEventListener('DOMContentLoaded', function() {
        // 创建监控实例
        window.pageMonitorInstance = new PageMonitor({
            system: '系统名称',
            apiKey: 'API密钥',
            isSPA: false,
            isTrackDownloads: true,
            activeTimeThreshold: 600, // 活跃时间阈值（秒） 即10分钟
            customEvents: [
                {
                    selector: '.btn',
                    eventType: 'click',
                    properties: {
                        category: 'button',
                        action: 'click'
                    }
                }
            ]
        });
    });
&lt;/script&gt;</code></pre>
            </div>
        </div>



    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // 获取用户名
            const username = localStorage.getItem('username');
            if (username) {
                document.getElementById('username').textContent = `欢迎，${username}`;
            }

            // 获取用户系统列表
            await fetchSystems();

            // 处理创建系统表单
            const createForm = document.getElementById('create-system-form');
            createForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const formData = new FormData(createForm);
                const data = Object.fromEntries(formData);

                const messageDiv = document.getElementById('create-message');
                messageDiv.style.display = 'none';

                try {
                    const response = await fetch('/sites', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            site_name: data.system_name,
                            site_url: data.site_url
                        })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        messageDiv.textContent = '系统监控创建成功！';
                        messageDiv.className = 'success-message';
                        messageDiv.style.display = 'block';
                        
                        // 清空表单
                        createForm.reset();
                        
                        // 重新加载系统列表
                        await fetchSystems();
                    } else {
                        messageDiv.textContent = result.detail || '系统创建失败，请稍后重试';
                        messageDiv.className = 'error-message';
                        messageDiv.style.display = 'block';
                    }
                } catch (error) {
                    messageDiv.textContent = '网络错误，请稍后重试';
                    messageDiv.className = 'error-message';
                    messageDiv.style.display = 'block';
                }
            });
        });

        // 获取用户系统列表
        async function fetchSystems() {
            const container = document.getElementById('systems-container');
            const messageDiv = document.getElementById('message');
            
            try {
                const response = await fetch('/sites');
                
                if (response.ok) {
                    const systems = await response.json();
                    
                    if (systems.length === 0) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-box-open"></i>
                                <h3>您还没有任何系统在监控</h3>
                                <p>请使用下方的表单创建您的第一个系统的监控</p>
                            </div>
                        `;
                    } else {
                        container.innerHTML = systems.map(system => `
                            <div class="system-card" data-system-name="${system.site_name}">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <h2><i class="fas fa-globe"></i> ${system.site_name}</h2>
                                    <button class="delete-btn" onclick="deleteSystem('${system.site_name}');" title="删除系统">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                <div class="system-url">${system.site_url}</div>
                                <div class="api-key">
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                        <span class="api-key-label">嵌入代码</span>
                                        <button class="copy-btn" onclick="copyCode('code-${system.site_name}', this);" title="复制嵌入代码">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                    <pre><code id="code-${system.site_name}">&lt;script src="${window.location.origin}/public/pagemonitor.min.js" data-system="${system.site_name}" data-api-key="${system.api_key}"&gt;&lt;/script&gt;</code></pre>
                                </div>
                                <div style="text-align: right; color: var(--primary-color); font-size: 14px; cursor: pointer;" onclick="selectSystem('${system.site_name}');">
                                    <i class="fas fa-chart-line"></i> 查看监控数据 &gt;
                                </div>
                                <div class="authorization-section">
                                    <h3><i class="fas fa-user-shield"></i> 授权管理</h3>
                                    <div class="authorization-controls">
                                        <div style="display: flex; margin-bottom: 15px;">
                                            <input type="text" id="add-user-${system.site_name}" placeholder="输入用户名" style="flex: 1; padding: 8px; margin-right: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                            <button onclick="addAuthorizedUser('${system.site_name}')" class="action-btn" style="padding: 8px 16px; background-color: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;" title="添加授权用户">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                        <div class="authorized-users-list" id="authorized-users-${system.site_name}">
                                            <!-- 授权用户列表将通过JavaScript动态生成 -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                        
                        // 实现复制代码功能
                        window.copyCode = function(codeId, button) {
                            const codeElement = document.getElementById(codeId);
                            if (codeElement) {
                                // 获取原始的HTML字符串并解码
                                let codeContent = codeElement.textContent;
                                
                                // 创建临时文本区域用于复制
                                const tempTextArea = document.createElement('textarea');
                                tempTextArea.value = codeContent;
                                document.body.appendChild(tempTextArea);
                                tempTextArea.select();
                                
                                try {
                                    document.execCommand('copy');
                                    // 显示复制成功状态
                                    const originalText = button.innerHTML;
                                    button.innerHTML = '<i class="fas fa-check"></i> 已复制';
                                    button.classList.add('copied');
                                    
                                    // 3秒后恢复原始状态
                                    setTimeout(() => {
                                        button.innerHTML = originalText;
                                        button.classList.remove('copied');
                                    }, 3000);
                                } catch (err) {
                                    console.error('复制失败:', err);
                                } finally {
                                    document.body.removeChild(tempTextArea);
                                }
                            }
                        };
                    }
                } else if (response.status === 401) {
                    // 未登录，跳转到登录页面
                    window.location.href = '/login.html';
                } else {
                    messageDiv.textContent = '获取系统列表失败';
                    messageDiv.className = 'error-message';
                    messageDiv.style.display = 'block';
                }
            } catch (error) {
                messageDiv.textContent = '网络错误，请稍后重试';
                messageDiv.className = 'error-message';
                messageDiv.style.display = 'block';
            }
        }

        // 选择系统
        function selectSystem(siteName) {
            // 将选中的系统信息存储到localStorage
            localStorage.setItem('selectedSiteName', siteName);
            
            // 跳转到监控页面
            window.location.href = '/';
        }
        
        // 删除系统
        function deleteSystem(siteName) {
            // 显示确认对话框
            if (!confirm(`确定要删除系统 "${siteName}" 吗？\n此操作将删除所有监控数据和网站配置，不可恢复。`)) {
                return;
            }
            
            // 显示加载提示
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = '正在删除系统...';
            messageDiv.className = 'info-message';
            messageDiv.style.display = 'block';
            
            // 执行删除操作
            Promise.resolve()
                .then(() => fetch(`/sites/${siteName}`, {
                    method: 'DELETE',
                    credentials: 'include'  // 包含cookie以便认证
                }))
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`删除网站记录失败 (${response.status})`);
                    }
                    return response.json();
                })
                // 删除成功
                .then(result => {
                    messageDiv.textContent = `系统 "${siteName}" 删除成功！`;
                    messageDiv.className = 'success-message';
                    messageDiv.style.display = 'block';
                    
                    // 刷新页面，重新加载系统列表
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                })
                // 删除失败
                .catch(error => {
                    console.error('删除系统失败:', error);
                    messageDiv.textContent = `删除系统失败: ${error.message}`;
                    messageDiv.className = 'error-message';
                    messageDiv.style.display = 'block';
                });
        }

        // 修改密码相关功能
        let passwordModal;
        let closeBtn;
        let cancelBtn;
        let passwordForm;
        
        // 初始化模态窗口元素
        function initPasswordModal() {
            passwordModal = document.getElementById('password-modal');
            closeBtn = document.querySelector('.close-btn');
            cancelBtn = document.querySelector('.cancel-btn');
            passwordForm = document.getElementById('password-form');
            
            // 关闭模态窗口的事件监听
            closeBtn.onclick = closeChangePasswordModal;
            cancelBtn.onclick = closeChangePasswordModal;
            
            // 点击模态窗口外部关闭
            window.onclick = function(event) {
                if (event.target == passwordModal) {
                    closeChangePasswordModal();
                }
            }
            
            // 处理密码表单提交
            passwordForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(passwordForm);
                const data = Object.fromEntries(formData);
                
                const messageDiv = document.getElementById('password-message');
                messageDiv.style.display = 'none';
                
                try {
                    const response = await fetch('/user/change-password', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        messageDiv.textContent = '密码修改成功！';
                        messageDiv.className = 'success-message';
                        messageDiv.style.display = 'block';
                        
                        // 3秒后关闭模态窗口
                        setTimeout(() => {
                            closeChangePasswordModal();
                            messageDiv.style.display = 'none';
                            passwordForm.reset();
                        }, 2000);
                    } else {
                        messageDiv.textContent = result.detail || '密码修改失败，请稍后重试';
                        messageDiv.className = 'error-message';
                        messageDiv.style.display = 'block';
                    }
                } catch (error) {
                    messageDiv.textContent = '网络错误，请稍后重试';
                    messageDiv.className = 'error-message';
                    messageDiv.style.display = 'block';
                }
            });
        }
        
        // 打开修改密码模态窗口
        function openChangePasswordModal() {
            if (!passwordModal) {
                initPasswordModal();
            }
            passwordModal.style.display = 'block';
        }
        
        // 关闭修改密码模态窗口
        function closeChangePasswordModal() {
            if (passwordModal) {
                passwordModal.style.display = 'none';
                // 清空表单和消息
                const messageDiv = document.getElementById('password-message');
                messageDiv.style.display = 'none';
                passwordForm.reset();
            }
        }
        
        // 退出登录
        async function logout() {
            // 添加登出确认对话框
            const confirmed = confirm('确定要登出吗？');
            if (!confirmed) {
                return; // 用户取消登出
            }
            
            try {
                // 发送登出请求 (后端已改为GET请求)
                const response = await fetch('/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'  // 包含cookie
                });
                
                if (response.ok) {
                    localStorage.removeItem('username');
                    localStorage.removeItem('selectedSiteName');
                    // 登出成功，重定向到登录页面
                    window.location.href = '/login.html';
                } else {
                    console.error('登出失败');
                    // 即使失败也跳转到登录页面
                    window.location.href = '/login.html';
                }
            } catch (error) {
                console.error('登出错误:', error);
                // 发生错误时跳转到登录页面
                window.location.href = '/login.html';
            }
        }
    </script>
    
    <!-- 修改密码模态窗口 -->
    <div id="password-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-key"></i> 修改密码</h2>
                <button class="close-btn">&times;</button>
            </div>
            <div id="password-message" style="display: none;"></div>
            <form id="password-form" class="password-form">
                <div class="form-group">
                    <label for="current-password">当前密码</label>
                    <input type="password" id="current-password" name="current_password" placeholder="请输入当前密码" required>
                </div>
                <div class="form-group">
                    <label for="new-password">新密码</label>
                    <input type="password" id="new-password" name="new_password" placeholder="请输入新密码" required>
                </div>
                <div class="form-group">
                    <label for="confirm-password">确认新密码</label>
                    <input type="password" id="confirm-password" name="confirm_password" placeholder="请再次输入新密码" required>
                </div>
                <div class="password-form-actions">
                    <button type="button" class="cancel-btn">取消</button>
                    <button type="submit" class="save-btn">保存修改</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 授权管理相关的JavaScript函数 -->
    <script>
        // 加载网站的授权用户列表
        async function loadAuthorizedUsers(siteName) {
            try {
                const response = await fetch(`/sites/${siteName}/users`, {
                    credentials: 'include'  // 包含cookie以便认证
                });
                
                if (!response.ok) {
                    throw new Error(`获取授权用户列表失败 (${response.status})`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    const userListElement = document.getElementById(`authorized-users-${siteName}`);
                    userListElement.innerHTML = '';
                    
                    // 添加创建者信息
                    if (result.creator) {
                        const creatorItem = document.createElement('div');
                        creatorItem.className = 'authorized-user-item creator';
                        creatorItem.innerHTML = `
                            <span class="username">${result.creator.username}</span>
                            <span class="full-name">(${result.creator.full_name || result.creator.username})</span>
                            <span class="email">${result.creator.email || ''}</span>
                            <span class="creator-badge">创建者</span>
                        `;
                        userListElement.appendChild(creatorItem);
                    }
                    
                    // 添加其他授权用户
                    result.users.forEach(user => {
                        // 跳过创建者（已经单独显示）
                        if (result.creator && user.username === result.creator.username) {
                            return;
                        }
                        
                        const userItem = document.createElement('div');
                        userItem.className = 'authorized-user-item';
                        userItem.innerHTML = `
                            <span class="username">${user.username}</span>
                            <span class="full-name">(${user.full_name || user.username})</span>
                            <span class="email">${user.email || ''}</span>
                            <button onclick="removeAuthorizedUser('${siteName}', '${user.username}')" class="remove-btn" title="移除授权">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        userListElement.appendChild(userItem);
                    });
                } else {
                    console.error('获取授权用户列表失败:', result.message);
                }
            } catch (error) {
                console.error('获取授权用户列表出错:', error);
            }
        }
        
        // 添加授权用户
        async function addAuthorizedUser(siteName) {
            const inputElement = document.getElementById(`add-user-${siteName}`);
            const username = inputElement.value.trim();
            
            if (!username) {
                alert('请输入用户名');
                return;
            }
            
            try {
                const response = await fetch(`/sites/${siteName}/users`, {
                    method: 'POST',
                    credentials: 'include',  // 包含cookie以便认证
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username: username })
                });
                
                if (!response.ok) {
                    throw new Error(`添加授权用户失败 (${response.status})`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    alert(result.message);
                    inputElement.value = '';  // 清空输入框
                    loadAuthorizedUsers(siteName);  // 重新加载用户列表
                } else {
                    alert('添加授权用户失败: ' + (result.message || '未知错误'));
                }
            } catch (error) {
                console.error('添加授权用户出错:', error);
                alert('添加授权用户出错: ' + error.message);
            }
        }
        
        // 移除授权用户
        async function removeAuthorizedUser(siteName, username) {
            if (!confirm(`确定要移除用户 ${username} 对系统 "${siteName}" 的访问权限吗？`)) {
                return;
            }
            
            try {
                const response = await fetch(`/sites/${siteName}/users/${username}`, {
                    method: 'DELETE',
                    credentials: 'include'  // 包含cookie以便认证
                });
                
                if (!response.ok) {
                    throw new Error(`移除授权用户失败 (${response.status})`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    alert(result.message);
                    loadAuthorizedUsers(siteName);  // 重新加载用户列表
                } else {
                    alert('移除授权用户失败: ' + (result.message || '未知错误'));
                }
            } catch (error) {
                console.error('移除授权用户出错:', error);
                alert('移除授权用户出错: ' + error.message);
            }
        }
        
        // 在加载系统列表后为每个系统加载授权用户
        document.addEventListener('DOMContentLoaded', function() {
            // 等待所有系统卡片渲染完成
            setTimeout(() => {
                const systemCards = document.querySelectorAll('.system-card');
                systemCards.forEach(card => {
                    const siteName = card.dataset.systemName;
                    if (siteName) {
                        loadAuthorizedUsers(siteName);
                    }
                });
            }, 500);
        });
    </script>
</body>
</html>